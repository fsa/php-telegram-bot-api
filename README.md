# Библиотека PHP для работы с Telegram Bot API

Данная библиотека может использоваться для упрощения взаимодействия с Telegram Bot API - <https://core.telegram.org/bots/api>. С их помощью можно произвести декодирование сообщений и преобразовать их в объекты PHP, а также осуществить подготовку сообщений для отправки. API описано не полностью, но позволяет обеспечить обработку большей части запросов и сформировать некоторые типы сообщений.

Перед выполнением запросов необходимо выполнить инициализацию:

```php
FSA\Telegram\Query::init($config);
```

где

`$config` - массив с параметрами инициализации:

- `$config['token']` - ваш ключ Telegram Bot API;
- `$config['proxy']` - адрес прокси, если необходим.

Параметры могут содержать и другие ключи, значение которых можно будет получить через getConfigVar() с указанием имени параметра:

```php
$admin_id=FSA\Telegram\Query::getConfigVar('admin_id');
```

Если параметр не задан в массиве, то будет возвращён null.

Инициализация будет вызвана автоматически при использовании WebHook::getUpdate().

## Обработка WebHook

Получение Update, полученного через Webhook:

```php
$update=FSA\Telegram\Webhook::getUpdate($config);
```

В результате будет получен объект типа Update. Массив $config будет передан в `Query::init($config)`. При этом, если в массиве будет присутствовать ключ `admin_id`, то он будет использовать как адрес чата администратора, куда будут направляться сообщения об ошибках.

Ответ на WebHook может быть выполнен с помощью метода webhookReplyJson().

```php
$reply=new \FSA\Telegram\SendMessage();
$reply->setChatId($chat_id);
$reply->setText("Привет");
$reply->webhookReplyJson();
```

### Обработка ошибок

при указании контакта администратора все сообщения об ошибках будут направлены ему в виде сообщений. Изменить получения сообщений можно с помощью метода:

```php
FSA\Telegram\Webhook::setExceptionHandler($chat_id);
```

При этом если класс исключения имеет имя UserException в любом пространстве имён, то пользователь получит текст сообщения в виде ответа на свой запрос. Для всех других исключений пользователю будет сообщено об ошибке обработки запроса, а подробности ошибки будет отправлены администратору, если он был задан при инициализации.

### Ведение лога запросов

Передача отладочной информации осуществляется с помощью команды `syslog`. Запись JSON с запросом может быть передано в виде `LOG_DEBUG` с помощью метода `Webhook::logRequest()`. Вызов метода должен выполняться после разбора `Update` через `Webhook::getUpdate($config)`. Если в процессе разбора JSON возникает ошибка, то информация о ней вместе с текстом запроса будет направлено в лог автоматически как `LOG_ERR`.

При необходимости, можно выполнить настройку ведения журнала перед вызовом Webhook:

```php
openlog("my_prog", LOG_PID | LOG_ODELAY, LOG_USER);
```

## Выполнение запросов на сервер

Запросы на сервер выполняются с помощью методов `httpGet()`, `httpPost()` или `httpPostJson()`. При этом необходимо предварительно установить токен доступа и прокси (если необходим) через массив конфигурации.

```php
# Инициализация
\FSA\Telegram\Query::init($config);
# Передача Message
$reply=new \FSA\Telegram\SendMessage();
$reply->setChatId($chat_id);
$reply->setText("Привет");
$reply->httpPost();
```
