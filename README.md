# Библиотека PHP для работы с Telegram Bot API

Данная библиотека может использоваться для упрощения взаимодействия с Telegram Bot API - <https://core.telegram.org/bots/api>. С её помощью можно формировать запросы к API и передавать на сервер. Кроме этого, библиотека поддерживает возможность использовать Webhook.

## Создание сообщения для запроса на сервер

Дла методов Telegram Bot API созданы соответствующие классы. Отличие имени метода от имени класса в том, что имя класса начинается с заглавной буквы.

Доступные методы API:

* getFile;
* getMe;
* getUpdates;
* getWebhookInfo;
* sendDice;
* sendLocation;
* sendMessage;
* sendSticker;
* setWebhook.

Конструкторы соответствующих классов в качестве аргументов требуют соответствующие обязательные параметры. При установке необязательных аргументов можно использовать цепочки методов, например:

```php
$message = (new FSA\Telegram\SendDice($chat_id, 1))->setDisableNotification()->setProtectContent();
```

## Выполнение запросов на сервер

Запросы на сервер выполняются с помощью методов `httpGet()`, `httpPost()` или `httpPostJson()`. При этом необходимо установить токен доступа и прокси, если необходим, в конструкторе `FSA\Telegram\Query`.

```php
// Создание нового запроса
$query = new FSA\Telegram\Query('TOKEN');
// Создание метода sendMessage
$message = new FSA\Telegram\SendMessage($chat_id, "Привет");
// Передача запроса на сервер
$query->httpPostJson($message);
```

## Ответ на WebHook

Ответ на WebHook может быть выполнен с помощью метода webhookReplyJson().

```php
$query = new FSA\Telegram\Query('TOKEN');
$reply=new \FSA\Telegram\SendMessage($chat_id, "Привет");
$query->webhookReplyJson($reply);
```

## Вспомогательный класс Helper

Позволяет быстро настроить взаимодействие с серверами телеграм. Перед использованием нужно инициализировать класс:

```php
FSA\Telegram\Helper::init($config);
```

где

`$config` - массив с параметрами инициализации:

* `$config['token']` - ваш ключ Telegram Bot API, обязательный параметр;
* `$config['proxy']` - адрес прокси, если необходим;
* `$config['api_url']` - адрес Local Bot API сервера, если необходимо.

Параметры могут содержать и другие ключи, значение которых можно будет получить через getConfigVar() с указанием имени параметра:

```php
$admin_id = FSA\Telegram\Helper::getConfigVar('admin_id');
```

Если параметр не задан в массиве, то будет возвращён null.

### Отправка запросов на сервер

Запросы можно выполнять тремя способами. Все методы соответствуют методам `FSA\Telegram\Query`:

```php
FSA\Telegram\Helper::httpGet($query);
FSA\Telegram\Helper::httpPost($query);
FSA\Telegram\Helper::httpPostJson($query);
```

### Работа с Webhook

Получение данных запроса:

```php
FSA\Telegram\Helper::getWebhookUpdate();
```

Данные можно получить в сыром виде:

```php
FSA\Telegram\Helper::getWebhookUpdateRaw();
```

Получать данные запроса можно любое число раз. Оригинальный запрос сохраняется внутри `Helper` и используется при последующих запросах.

При первом получении запроса устанавливается обработчик исключений. Данные об ошибках при обработке Webhook будут отправлены администратору на аккаунт в телеграм, если он указан в массиве параметров инициализации в ключе `admin_id`. Чтобы пользователь смог получать сообщения об ошибках необходимо указать его `chat_id` с помощью метода:

```php
FSA\Telegram\Helper::setExceptionChatId($chat_id);
```

После этого при возникновении исключения пользователь в `$chat_id` будет оповещён о проблеме. Текст исключения `UserException` из любого пространства имён будет передан пользователю без изменения. При других типах исключений пользователю будет сообщено об ошибке, при этом будет отправлено оповещение на учётную запись администратора (если он был указан).

Для отправки ответа на Webhook можно применять метод `webhookReplyJson`:

```php
FSA\Telegram\Helper::webhookReplyJson($query);
```

Отправить ответ можно только один раз. После отправки ответа работа скрипта будет остановлена.
